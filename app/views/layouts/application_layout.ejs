<% if(!req.query._pjax) { %>
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
    <head>
        <title><%= req.title || req.page.metaTitle || req.page.title + " - " + req.group.name %></title>
        <meta name="keywords" content="<%- req.page.metaKeywords || req.group.metaKeywords %>" />
        <meta name="description" content="<%- req.page.metaDescription || req.group.metaDescription %>" />

        <!-- opengraph tags -->
        <meta property="og:title" content="<%= (req.content && req.content.title) || req.page.metaTitle || req.page.title + ' - ' + req.group.name %>" />
        <meta property="og:description" content="<%= req.content && (req.content.excerpt || stripHtml(req.content.text, 280)) || req.page.metaDescription || req.group.metaDescription %>" />
        <meta property="og:url" content="<%- req.protocol %>://<%- req.content && req.content.url || req.page.url %>" />
        <% if(req.content && req.content.previewImage) { %><meta property="og:thumbnail" content="<%- req.content && req.content.previewImage %>" /><% } %>
        <meta property="og:type" content="<%- req.content && 'article' || 'website' %>" />
        <meta property="og:site_name" content="<%- req.group.name %>" />

        <%- javascriptIncludeTag('jquery', 'bootstrap', 'bootstrap-typeahead', 'jquery-easyticker', 'jquery-hoverintent', 'jquery-blink', 'jquery-valadd', 'jquery-textarea-autogrow', 'jquery-noty', 'jquery-cookie', 'jquery-pjax', 'jquery-hovercard', 'jquery-highlight', 'uploader', 'rails', 'hatch-search', 'hatch', 'hatch-io', 'jquery-zoom', 'application')
        %>

        <% if((req.headers['user-agent'] || '').indexOf('iPad') == -1) { %>
            <meta name="viewport" content="width=480, user-scalable=no" />
        <% } %>

        <meta name="userid" content="<%- req.user && req.user.id %>" />
        <%- csrfMetaTag() %>
        <meta name="pageId" content="<%- req.page && req.page.id %>" />
        <meta name="groupId" content="<%- req.group && req.group.id %>" />

        <script type="text/javascript">
            canEdit = <%- (request.member && request.user.canEdit) ? "true":"false" %>;
        </script>

        <link type="text/css" rel="stylesheet" href="<%- pathFor('stylesheet').css(req.group.cssVersion || 0) %>" id="main-stylesheet" />

        <style id="preview-stylesheet" type="text/css"></style>

        <% if (req.group.favicon) { %>
            <link rel="shortcut icon" href="<%- req.group.favicon %>" />
        <% } %>

        <% if (request.member && request.user.canEdit) { %>
            <%- javascriptIncludeTag('jquery-ui.min', 'chosen.jquery', 'jquery-rule', 'jquery-datatables', 'jquery-selectrange', 'jquery-blockui', 'jquery-spectrum', 'jquery-colorscheme', 'hatch-dragdrop', 'hatch-css-properties', 'hatch-styleeditor', 'hatch-inline-edit', 'hatch-management', 'redactor/redactor') %>
            <link rel="stylesheet" href="/javascripts/redactor/redactor.css" />
        <% } %>
    </head>
    <body class="<%- req.group.navBarType === 'fixed' ? 'navbar-fixed':'' %>">

    <div id="all">
    <% } else { %>
        <!-- pjax title -->
        <title><%= req.page.metaTitle || req.page.title + " - " + req.group.name %></title>
    <% } %>

    <div class="navbar navbar-top <%- req.group.navBarType && req.group.navBarType !== 'default' ? 'navbar-fixed-top':'' %> navbar-type-<%- req.group.navBarType %> navbar-<%- req.group.navBarStyle %>">
        <div class="navbar-inner">
            <div class="container">
                <div class="navbar-container">

                    <a class="brand" href="//<%- req.group.homepage.url -%>">
                        <span class="group-name"><%- req.group.name %></span>
                    </a>
                    <div>
                        <%- hook('layout.topBar.left') %>
                        <% if (req.user && !request.member && !req.pending && req.group.joinPermissions != 'closed') { %>
                            <ul class="nav pull-left">    
                                <li><a href="<%- pathFor('user').join() %>"><i class="icon-star"></i> <%- t('layout.joinGroup') %></a></li>
                            </ul>
                        <% } %>
                        <% if (request.member && request.user.canEdit) { %>
                            <!-- TODO: we need a way of disabling edit console for the entire admin module -->
                            <ul class="nav pull-left visible-desktop">
                                <li><% linkTo(icon('cog') + t('layout.manageGroup'), pathFor('admin').groupPages(req.group), {id: 'manage-group-link'}) %></li>
                                <li><% linkTo(
                                    icon('eye-close') +
                                    icon('eye-open') + t('layout.toggleEditConsole'),
                                    '#edit', {
                                        style: 'display:none',
                                        id: 'edit-page-link',
                                        accesskey: 'e'
                                    }) %>
                            </ul>
                        <% } %>
                    </div>
                    <div class="pull-right">
                        <%- hook('layout.topBar.middle') %>
                        <% if (request.user) { var user = request.user; %>
                            <ul class="nav">
                                <li class="dropdown" id="menu1">
                                    <a class="dropdown-toggle" data-toggle="dropdown" href="/">
                                        <%= user.displayName || user.username || user.email %>
                                        <b class="caret"></b>
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li><%- linkTo('<i class="icon-user"></i> ' + t('layout.viewProfile'), specialPagePath('profile', { username: req.user.username })) %></li>
                                        <li><a href="<%- specialPagePath('account') %>"><i class="icon-cogs"></i> <%- t('layout.editProfile') %></a></li>
                                        <li class="divider"></li>
                                        <li> <%- linkTo('<i class="icon-off"></i> ' + t('layout.signOut'), pathFor('user').logout) %> </li>
                                    </ul>
                                </li>
                            </ul>
                        <% } else { %>
                            <ul class="nav">
                                <li><%- linkTo(t('layout.signIn'), '#login', {'data-toggle': "modal"}) %></li>
                                <% if(req.group.joinPermissions !== 'closed') { %>
                                    <li><%- linkTo(t('layout.joinGroup'), '#register', {'data-toggle': "modal"}) %></li>
                                <% } else { %>
                                    <li><%- linkTo(t('layout.register'), '#register', {'data-toggle': "modal"}) %></li>
                                <% } %>
                            </ul>
                        <% } %>
                        <%- hook('layout.topBar.right') %>
                    </div>
                </div><!--/.nav-collapse -->
            </div>
        </div>
    </div>

    <% if (req.pending) { %>
        <div class="container alert-container">
            <div class="alert alert-block alert-success">
                <% if (req.pending.requested) { %>
                <p>
                    <strong><%- t('layout.groupAccessRequestedTitle') %></strong>
                    <br/>
                    <%- icon('time') + t('layout.groupAccessRequestedDescription') %>
                </p>
                <% } else { %>
                <p>

                    <%- icon('info-sign') + t('layout.invitedToGroup') %>
                </p>
                <p class="lead">
                    <%- linkTo(icon('ok') + t('layout.acceptInvitation'),pathFor('user').join(), {class: 'text-success'}) %>
                    /
                    <%- linkTo(t('layout.ignoreInvitation'), pathFor('user').rejectInvitation(), {class: 'text-success'}) %>
                </p>
                <% } %>
            </div>
        </div>
    <% } else if (req.user && req.user.type === 'temporary' && req.url.indexOf(specialPagePath('register')) == -1) { %>
        <div class="container alert-container">
            <div class="alert alert-block alert-information">
                <p>
                    <strong><%- t('layout.registration.inProgress') %></strong>
                    <br/>
                    <%- t(['layout.registration.suggestProceed', linkTo(t('layout.registration.go'), specialPagePath('register') + '?redirect=' + pathFor('user').join())]) %>
                </p>
            </div>
        </div>
    <% } %>

    <div id="main">

        <div id="row-content">
            <%- body %>
        </div>

        <hr />

        <div class="container footer-container">
            <footer>
                <div class="pull-right">
                    <i class="icon-bolt"></i>
                    <span id="pagetimer">
                        <%- t(['layout.renderSpeed', (new Date() - req.startedAt) / 1000]) %>
                    </span>
                </div>

                <%- req.group.footerHtml || t('common.bragHatch') %>
            </footer>
        </div>

        <%- hook('layout.body.end') %>

<% if(!req.query._pjax) { %>
    </div>
    </div>

    <div id="blank-modal" class="modal fade"></div>

    <% if (!request.user) { %>
        <% include _register %>
        <% include _reset-password %>
        <% include _login %>
    <% } else if (user.canEdit) { %>
        <% include Webfonts %>
        <div id="editConsoleHolder"></div>
    <% }%>

    <% if(req.group.googleAnalyticsId) { %>

        <script type="text/javascript">

            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', '<%- req.group.googleAnalyticsId %>']);
            _gaq.push(['_setDomainName', '<%- req.headers.host %>']);
            _gaq.push(['_trackPageview']);

            (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();

        </script>

    <% } %>

</body>
</html>

<% } %>
